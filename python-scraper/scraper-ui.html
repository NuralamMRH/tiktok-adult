<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ScrapeFlow v3 | Target Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@400;500&display=swap');

      body {
        font-family: 'Inter', sans-serif;
        background-color: #020617;
        color: #e2e8f0;
      }
      .glass-card {
        background: rgba(15, 23, 42, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.05);
      }
      .custom-scrollbar::-webkit-scrollbar {
        width: 5px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: #0f172a;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #334155;
        border-radius: 10px;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .json-editor {
        font-family: 'Fira Code', monospace;
        background: #000;
        color: #10b981;
        border: 1px solid #1e293b;
        resize: vertical;
      }
      .modal-overlay {
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
      }
      .post-card:hover .post-actions {
        opacity: 1;
      }
    </style>
  </head>
  <body class="flex h-screen overflow-hidden">
    <div
      id="toast"
      class="fixed bottom-6 right-6 z-[200] hidden max-w-md rounded-2xl border border-slate-800 bg-slate-950/90 px-5 py-4 text-sm text-slate-200 shadow-2xl"
    ></div>
    <!-- Sidebar -->
    <aside
      id="sidebar"
      class="glass-card z-50 flex h-full w-64 flex-col border-r border-slate-900"
    >
      <div class="p-6">
        <div class="mb-10 flex items-center gap-3">
          <div
            class="rounded-xl bg-indigo-600 p-2 shadow-lg shadow-indigo-500/20"
          >
            <i class="fas fa-bolt text-xl text-white"></i>
          </div>
          <h1 class="text-xl font-black italic tracking-tighter">
            SCRAPE<span class="text-indigo-500">FLOW</span>
          </h1>
        </div>

        <nav class="space-y-2">
          <button
            onclick="switchTab('targets')"
            class="nav-link flex w-full items-center gap-3 rounded-xl bg-indigo-600 px-4 py-3 font-semibold text-white shadow-lg shadow-indigo-600/20"
            id="nav-targets"
          >
            <i class="fas fa-bullseye w-5"></i> Targets
          </button>
          <button
            onclick="switchTab('results')"
            class="nav-link flex w-full items-center gap-3 rounded-xl px-4 py-3 text-slate-400 transition hover:bg-slate-800/50"
            id="nav-results"
          >
            <i class="fas fa-database w-5"></i> Finished Results
          </button>
          <button
            onclick="switchTab('active-runs')"
            class="nav-link flex w-full items-center gap-3 rounded-xl px-4 py-3 text-slate-400 transition hover:bg-slate-800/50"
            id="nav-runs"
          >
            <i class="fas fa-satellite-dish w-5"></i> Live Stream
          </button>
          <button
            onclick="switchTab('schedules')"
            class="nav-link flex w-full items-center gap-3 rounded-xl px-4 py-3 text-slate-400 transition hover:bg-slate-800/50"
            id="nav-schedules"
          >
            <i class="fas fa-calendar-alt w-5"></i> Schedules
          </button>
        </nav>
      </div>

      <div class="mt-auto space-y-4 border-t border-slate-900 p-6">
        <div
          class="rounded-2xl border border-indigo-500/20 bg-indigo-950/30 p-4"
        >
          <p class="mb-1 text-[10px] font-black uppercase text-indigo-400">
            Current Task
          </p>
          <p class="truncate text-xs font-bold">mmsbaba.com</p>
          <div
            class="mt-2 h-1 w-full overflow-hidden rounded-full bg-slate-800"
          >
            <div class="h-full w-2/3 animate-pulse bg-indigo-500"></div>
          </div>
        </div>
        <button
          onclick="toggleModal('importModal', true)"
          class="w-full rounded-xl border border-slate-800 bg-slate-900 py-3 text-xs font-bold text-slate-300 transition hover:bg-slate-800"
        >
          <i class="fas fa-file-import mr-2"></i> IMPORT CONFIG
        </button>
      </div>
    </aside>

    <main class="relative flex flex-1 flex-col overflow-hidden">
      <!-- Header -->
      <header
        class="glass-card flex h-20 items-center justify-between border-b border-slate-900 px-8"
      >
        <div class="flex items-center gap-6">
          <h2 id="pageTitle" class="text-xl font-bold">Targets Manager</h2>
          <div class="h-6 w-px bg-slate-800"></div>
          <div class="flex gap-3">
            <button
              onclick="runAllTargets(event)"
              class="rounded-full bg-emerald-600 px-5 py-2 text-xs font-black text-white shadow-lg shadow-emerald-600/20 transition hover:bg-emerald-500"
            >
              <i class="fas fa-play mr-2"></i> RUN ALL TARGETS
            </button>
          </div>
        </div>

        <div class="flex items-center gap-4">
          <button
            onclick="openTargetModal(null)"
            class="flex h-10 w-10 items-center justify-center rounded-full bg-indigo-600 text-white shadow-lg shadow-indigo-600/20 transition hover:bg-indigo-500"
          >
            <i class="fas fa-plus"></i>
          </button>
        </div>
      </header>

      <div class="custom-scrollbar flex-1 overflow-y-auto p-8">
        <!-- TAB: TARGETS -->
        <div id="targets" class="tab-content active space-y-6">
          <div
            class="flex flex-col justify-between gap-6 md:flex-row md:items-center"
          >
            <div class="flex flex-col gap-3 md:flex-row md:items-center">
              <select
                id="presetSelect"
                class="min-w-[240px] rounded-2xl border border-slate-800 bg-slate-900 px-6 py-3 text-sm focus:border-indigo-500 focus:outline-none"
              ></select>
              <button
                id="loadPresetBtn"
                class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-3 text-xs font-bold transition hover:bg-slate-800"
              >
                Load Preset
              </button>
              <button
                id="importPresetBtn"
                class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-3 text-xs font-bold transition hover:bg-slate-800"
              >
                Import Preset JSON
              </button>
              <button
                onclick="openTargetModal(null)"
                class="rounded-xl border border-indigo-600 bg-indigo-600 px-4 py-3 text-xs font-bold text-white transition hover:bg-indigo-500"
              >
                <i class="fas fa-plus mr-2"></i> Add Target
              </button>
            </div>
            <div
              id="targetsMeta"
              class="text-xs font-bold text-slate-500"
            ></div>
          </div>

          <div
            id="targetsGrid"
            class="grid grid-cols-1 gap-6 xl:grid-cols-2"
          ></div>
        </div>

        <!-- TAB: RESULTS (TARGET BASED) -->
        <div id="results" class="tab-content space-y-8">
          <div
            class="flex flex-col justify-between gap-6 md:flex-row md:items-center"
          >
            <div class="flex items-center gap-4">
              <select
                id="resultsRunSelect"
                class="min-w-[240px] rounded-2xl border border-slate-800 bg-slate-900 px-6 py-3 text-sm focus:border-indigo-500 focus:outline-none"
              ></select>
              <div id="resultsMeta" class="text-xs font-bold text-slate-500">
                <i class="fas fa-info-circle mr-1"></i> Showing 40 results
              </div>
            </div>
            <div class="flex gap-2">
              <button
                id="downloadCsvBtn"
                class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-2 text-xs transition hover:bg-slate-800"
              >
                Download CSV
              </button>
              <button
                id="publishSanityBtn"
                class="rounded-xl border border-indigo-600/20 bg-indigo-600/10 px-4 py-2 text-xs font-bold text-indigo-400 transition hover:bg-indigo-600 hover:text-white"
              >
                Publish to Sanity
              </button>
              <button
                id="deleteRunBtn"
                class="rounded-xl border border-rose-600/20 bg-rose-600/10 px-4 py-2 text-xs text-rose-500 transition hover:bg-rose-600 hover:text-white"
              >
                Delete Run
              </button>
            </div>
          </div>

          <div
            id="publishPanel"
            class="glass-card hidden overflow-hidden rounded-3xl border border-slate-800 p-6"
          >
            <div class="mb-4 flex items-center justify-between">
              <div
                class="text-sm font-black uppercase tracking-widest text-slate-500"
              >
                Sanity Publishing Queue
              </div>
              <div class="flex items-center gap-2">
                <button
                  onclick="
                    if (state.publishTasks) {
                      state.publishTasks = [];
                      renderPublishTasks();
                      updatePublishUi();
                    }
                  "
                  class="text-[10px] text-slate-500 hover:text-white"
                >
                  CLEAR ALL
                </button>
              </div>
            </div>
            <div
              id="publishTasksContainer"
              class="custom-scrollbar max-h-[300px] space-y-4 overflow-y-auto"
            ></div>
          </div>

          <!-- POST CARDS GRID -->
          <div
            id="resultsGrid"
            class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3 2xl:grid-cols-4"
          ></div>
        </div>

        <!-- TAB: SCHEDULES -->
        <div id="schedules" class="tab-content space-y-6">
          <div class="mb-8 flex items-center justify-between">
            <h3 class="text-xl font-bold">Automation Queue</h3>
          </div>

          <div
            id="schedulesGrid"
            class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3"
          ></div>
        </div>

        <!-- TAB: LIVE STREAM (ACTIVE RUNS) -->
        <div id="active-runs" class="tab-content space-y-6">
          <div id="recentRunsList" class="space-y-4"></div>
          <!-- User's provided running JSON data as live progress card -->
          <div
            class="glass-card relative overflow-hidden rounded-[2.5rem] border-t-8 border-indigo-500 p-10"
          >
            <div
              class="pointer-events-none absolute right-0 top-0 p-10 opacity-5"
            >
              <i class="fas fa-satellite-dish text-[150px]"></i>
            </div>
            <div class="grid grid-cols-1 gap-12 lg:grid-cols-4">
              <div class="space-y-10 lg:col-span-3">
                <div
                  class="flex flex-col justify-between gap-6 md:flex-row md:items-center"
                >
                  <div>
                    <h3
                      id="liveBaseUrl"
                      class="text-3xl font-black italic text-white"
                    ></h3>
                    <div class="mt-2 flex items-center gap-3">
                      <span
                        id="liveRunId"
                        class="font-mono text-xs tracking-tighter text-slate-500"
                      ></span>
                      <span
                        id="livePing"
                        class="h-1.5 w-1.5 animate-ping rounded-full bg-emerald-500"
                      ></span>
                      <span
                        id="liveStatus"
                        class="text-[10px] font-black uppercase text-emerald-500"
                      ></span>
                    </div>
                  </div>
                  <div class="text-right">
                    <div
                      id="livePercent"
                      class="text-4xl font-black text-indigo-500"
                    ></div>
                    <div
                      class="text-[10px] font-bold uppercase tracking-widest text-slate-500"
                    >
                      Global Progress
                    </div>
                  </div>
                </div>

                <div class="space-y-4">
                  <div
                    class="h-3 w-full overflow-hidden rounded-full border border-slate-800 bg-slate-900"
                  >
                    <div
                      id="liveBar"
                      class="h-full w-[65%] rounded-full bg-gradient-to-r from-indigo-600 to-blue-500 shadow-[0_0_20px_rgba(79,70,229,0.5)]"
                    ></div>
                  </div>
                  <div
                    class="flex justify-between text-[10px] font-bold uppercase text-slate-500"
                  >
                    <span id="livePageText"></span>
                    <span id="livePhaseText"></span>
                  </div>
                </div>

                <div class="grid grid-cols-2 gap-6 md:grid-cols-4">
                  <div
                    class="group rounded-3xl border border-slate-900 bg-slate-950/50 p-6 transition hover:border-indigo-500/30"
                  >
                    <p
                      class="mb-2 text-[10px] font-black uppercase text-slate-500"
                    >
                      Processed
                    </p>
                    <p
                      id="liveProcessed"
                      class="text-2xl font-black text-white"
                    ></p>
                  </div>
                  <div
                    class="rounded-3xl border border-slate-900 bg-slate-950/50 p-6"
                  >
                    <p
                      class="mb-2 text-[10px] font-black uppercase text-slate-500"
                    >
                      New Items
                    </p>
                    <p
                      id="liveNewItems"
                      class="text-2xl font-black text-emerald-400"
                    ></p>
                  </div>
                  <div
                    class="rounded-3xl border border-slate-900 bg-slate-950/50 p-6"
                  >
                    <p
                      class="mb-2 text-[10px] font-black uppercase text-slate-500"
                    >
                      Skipped
                    </p>
                    <p
                      id="liveSkipped"
                      class="text-2xl font-black text-amber-500"
                    ></p>
                  </div>
                  <div
                    class="rounded-3xl border border-slate-900 bg-slate-950/50 p-6"
                  >
                    <p
                      class="mb-2 text-[10px] font-black uppercase text-slate-500"
                    >
                      Data Load
                    </p>
                    <p id="liveDataLoad" class="text-2xl font-black text-white">
                      <span class="text-xs text-slate-500">-</span>
                    </p>
                  </div>
                </div>

                <div
                  class="truncate rounded-2xl border border-slate-800 bg-slate-900/40 p-4 font-mono text-xs text-indigo-400"
                >
                  <span class="mr-2 text-slate-500">âžœ</span>
                  <span id="liveCurrentUrl"></span>
                </div>
              </div>

              <div class="flex flex-col gap-4">
                <div
                  class="flex flex-1 flex-col items-center justify-center rounded-[2rem] border border-rose-600/10 bg-rose-600/5 p-6 text-center"
                >
                  <div
                    id="stopRunBtn"
                    class="mb-4 flex h-16 w-16 cursor-pointer items-center justify-center rounded-full bg-rose-600 text-white shadow-xl shadow-rose-600/30 transition hover:scale-105"
                  >
                    <i class="fas fa-stop text-xl"></i>
                  </div>
                  <p class="text-sm font-bold text-rose-500">STOP SCRAPER</p>
                  <p
                    class="mt-2 px-4 text-[10px] italic leading-relaxed text-slate-500"
                  >
                    Emergency halt will stop all active threads immediately.
                  </p>
                </div>
              </div>
            </div>
          </div>
          <div
            class="glass-card overflow-hidden rounded-[2.5rem] border border-slate-800 p-8"
          >
            <div class="mb-4 flex items-center justify-between">
              <h4
                class="text-sm font-black uppercase tracking-widest text-slate-500"
              >
                Live Log
              </h4>
              <button
                id="reloadLogBtn"
                class="rounded-xl border border-slate-800 bg-slate-900 px-4 py-2 text-xs font-bold transition hover:bg-slate-800"
              >
                Reload
              </button>
            </div>
            <pre
              id="liveLog"
              class="custom-scrollbar max-h-[420px] overflow-y-auto whitespace-pre-wrap break-words rounded-3xl border border-slate-900 bg-black/60 p-6 font-mono text-xs text-slate-200"
            ></pre>
          </div>
        </div>
      </div>
    </main>

    <!-- MODAL: ADD/EDIT TARGET -->
    <div
      id="targetModal"
      class="modal-overlay fixed inset-0 z-[100] flex hidden items-center justify-center p-4"
    >
      <div
        class="glass-card w-full max-w-4xl overflow-hidden rounded-[3rem] border-slate-800 shadow-2xl"
      >
        <div class="space-y-10 p-10 lg:p-14">
          <div class="flex items-start justify-between">
            <div>
              <h3 class="text-3xl font-black">Configure Target</h3>
              <p class="mt-2 text-sm text-slate-500">
                Add a new domain and extraction rules.
              </p>
            </div>
            <button
              onclick="toggleModal('targetModal', false)"
              class="flex h-12 w-12 items-center justify-center rounded-full bg-slate-900 text-slate-400 transition hover:text-white"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>

          <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
            <div class="space-y-6 md:col-span-2">
              <div class="space-y-2">
                <label
                  class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                  >Base URL</label
                >
                <input
                  id="targetBaseUrlInput"
                  type="text"
                  placeholder="https://..."
                  class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                />
              </div>
              <div class="grid grid-cols-2 gap-6">
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Target Name</label
                  >
                  <input
                    id="targetNameInput"
                    type="text"
                    placeholder="e.g. MMS Baba"
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Schedule Every...</label
                  >
                  <select
                    id="targetScheduleSelect"
                    class="w-full cursor-pointer appearance-none rounded-2xl border border-slate-800 bg-black px-6 py-4 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="none">No Schedule</option>
                    <option value="15m">15 Minutes</option>
                    <option value="30m">30 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="2h">2 Hours</option>
                    <option value="6h">6 Hours</option>
                    <option value="12h">12 Hours</option>
                    <option value="24h">24 Hours</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Page Limit</label
                  >
                  <input
                    id="targetPageLimitInput"
                    type="number"
                    min="1"
                    placeholder="1"
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Max Posts</label
                  >
                  <input
                    id="targetMaxPostsInput"
                    type="number"
                    min="0"
                    placeholder="0 (Unlimited)"
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Scrape Order</label
                  >
                  <select
                    id="targetScrapeOrderSelect"
                    class="w-full cursor-pointer appearance-none rounded-2xl border border-slate-800 bg-black px-6 py-4 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="asc">Ascending (1 -> N)</option>
                    <option value="desc">Descending (N -> 1)</option>
                  </select>
                </div>
              </div>
              <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                <div class="space-y-2 md:col-span-1">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Pagination Type</label
                  >
                  <select
                    id="paginationModeSelect"
                    class="w-full cursor-pointer appearance-none rounded-2xl border border-slate-800 bg-black px-6 py-4 focus:border-indigo-500 focus:outline-none"
                  >
                    <option value="">Template (pageN)</option>
                    <option value="kvs_ajax">KVS AJAX</option>
                  </select>
                </div>
                <div class="space-y-2 md:col-span-1">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Page 1 Path</label
                  >
                  <input
                    id="paginationPage1Input"
                    type="text"
                    placeholder="/"
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div class="space-y-2 md:col-span-1">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >Page N Template</label
                  >
                  <input
                    id="paginationPageNInput"
                    type="text"
                    placeholder="/page/{page}/"
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
              </div>
              <div
                id="ajaxPaginationFields"
                class="grid hidden grid-cols-1 gap-6 md:grid-cols-2"
              >
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >AJAX Link Selector</label
                  >
                  <input
                    id="ajaxPaginationSelectorInput"
                    type="text"
                    placeholder='a[data-action="ajax"][data-block-id][data-parameters]'
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
                <div class="space-y-2">
                  <label
                    class="text-[10px] font-black uppercase tracking-widest text-slate-500"
                    >AJAX Next Selector</label
                  >
                  <input
                    id="ajaxPaginationNextSelectorInput"
                    type="text"
                    placeholder='a.next[data-action="ajax"][data-block-id][data-parameters]'
                    class="w-full rounded-2xl border border-slate-800 bg-black px-6 py-4 font-medium transition focus:border-indigo-500 focus:outline-none"
                  />
                </div>
              </div>
              <div class="space-y-4 pt-4">
                <label
                  class="flex items-center justify-between text-[10px] font-black uppercase tracking-widest text-slate-500"
                >
                  Advanced Selectors (JSON)
                  <span class="font-mono text-[9px] text-indigo-400"
                    >Validation: Pass</span
                  >
                </label>
                <textarea
                  id="targetConfigTextarea"
                  class="json-editor custom-scrollbar h-48 w-full rounded-3xl p-6 text-xs focus:outline-none"
                  spellcheck="false"
                >
{
  "pagination": { "pageN": "/page/(page)/" },
  "listing": {
    "entry": "div.videos a.video",
    "fields": [ { "name": "title", "source": "a.title" } ]
  }
}</textarea
                >
              </div>
            </div>

            <div class="space-y-6">
              <div
                class="space-y-6 rounded-[2rem] border border-slate-800 bg-slate-900/50 p-6"
              >
                <h4
                  class="mb-4 text-xs font-black uppercase tracking-tighter text-slate-500"
                >
                  Behavior Toggles
                </h4>
                <div class="flex items-center justify-between">
                  <span class="text-xs font-bold">Use Selenium</span>
                  <input
                    id="targetUseSeleniumToggle"
                    type="checkbox"
                    class="checked:after:left-5.5 relative h-5 w-10 cursor-pointer appearance-none rounded-full bg-slate-800 transition-all after:absolute after:left-0.5 after:top-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white after:content-[''] checked:bg-indigo-600"
                  />
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-xs font-bold">Auto Publish</span>
                  <input
                    id="targetAutoPublishToggle"
                    type="checkbox"
                    checked
                    class="checked:after:left-5.5 relative h-5 w-10 cursor-pointer appearance-none rounded-full bg-slate-800 transition-all after:absolute after:left-0.5 after:top-0.5 after:h-4 after:w-4 after:rounded-full after:bg-white after:content-[''] checked:bg-indigo-600"
                  />
                </div>
              </div>
            </div>
          </div>

          <div class="flex gap-4 border-t border-slate-900 pt-4">
            <button
              onclick="toggleModal('targetModal', false)"
              class="flex-1 rounded-2xl bg-slate-900 py-5 text-xs font-black uppercase tracking-widest transition hover:bg-slate-800"
            >
              Cancel
            </button>
            <button
              id="saveTargetBtn"
              class="flex-1 rounded-2xl bg-indigo-600 py-5 text-xs font-black uppercase tracking-widest shadow-2xl shadow-indigo-600/30 transition hover:bg-indigo-500"
            >
              Save Target Config
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: IMPORT -->
    <div
      id="importModal"
      class="modal-overlay fixed inset-0 z-[100] flex hidden items-center justify-center p-4"
    >
      <div
        class="glass-card w-full max-w-lg overflow-hidden rounded-[2.5rem] border-slate-800"
      >
        <div class="space-y-8 p-10">
          <div class="text-center">
            <i class="fas fa-file-import mb-4 text-3xl text-indigo-500"></i>
            <h3 class="text-2xl font-bold">Import Configuration</h3>
          </div>
          <textarea
            id="importPresetTextarea"
            class="json-editor h-48 w-full rounded-2xl p-6 text-xs focus:outline-none"
            placeholder="Paste your preset JSON here..."
          ></textarea>
          <button
            id="applyImportBtn"
            class="w-full rounded-2xl bg-indigo-600 py-4 text-xs font-bold uppercase shadow-lg shadow-indigo-600/20 transition hover:bg-indigo-500"
          >
            Apply Configuration
          </button>
        </div>
      </div>
    </div>

    <script>
      function switchTab(tabId) {
        document
          .querySelectorAll('.tab-content')
          .forEach((c) => c.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');

        document.querySelectorAll('.nav-link').forEach((l) => {
          l.classList.remove(
            'bg-indigo-600',
            'text-white',
            'shadow-lg',
            'shadow-indigo-600/20',
          );
          l.classList.add('text-slate-400');
        });

        const navMap = {
          targets: 'nav-targets',
          results: 'nav-results',
          'active-runs': 'nav-runs',
          schedules: 'nav-schedules',
        };
        const activeNav = document.getElementById(navMap[tabId]);
        activeNav.classList.remove('text-slate-400');
        activeNav.classList.add(
          'bg-indigo-600',
          'text-white',
          'shadow-lg',
          'shadow-indigo-600/20',
        );

        const titles = {
          targets: 'Targets Manager',
          results: 'Scraped Results Explorer',
          'active-runs': 'Live Engine Stream',
          schedules: 'Automation Queue',
        };
        document.getElementById('pageTitle').innerText = titles[tabId];
      }

      function toggleModal(modalId, show) {
        document.getElementById(modalId).classList.toggle('hidden', !show);
      }

      const state = {
        presets: [],
        selectedPresetId: '',
        targets: [],
        runs: [],
        jobs: [],
        selectedRunId: '',
        selectedRunPosts: [],
        editingTargetIndex: null,
        publish: { running: false, total: 0, startedAt: 0, result: null },
        webApiBase: '',
      };

      function el(id) {
        return document.getElementById(id);
      }

      function notify(message, type) {
        const toast = el('toast');
        if (!toast) return;
        toast.textContent = message || '';
        toast.classList.toggle('hidden', !message);
        toast.classList.remove(
          'border-rose-600/20',
          'bg-rose-600/10',
          'text-rose-200',
        );
        toast.classList.remove(
          'border-emerald-600/20',
          'bg-emerald-600/10',
          'text-emerald-200',
        );
        toast.classList.remove(
          'border-slate-800',
          'bg-slate-950/90',
          'text-slate-200',
        );
        if (type === 'error') {
          toast.classList.add(
            'border-rose-600/20',
            'bg-rose-600/10',
            'text-rose-200',
          );
        } else if (type === 'success') {
          toast.classList.add(
            'border-emerald-600/20',
            'bg-emerald-600/10',
            'text-emerald-200',
          );
        } else {
          toast.classList.add(
            'border-slate-800',
            'bg-slate-950/90',
            'text-slate-200',
          );
        }
        window.clearTimeout(state.toastTimer);
        state.toastTimer = window.setTimeout(() => {
          toast.classList.add('hidden');
        }, 3000);
      }

      function getApiPrefix() {
        const path = window.location.pathname;
        if (path.endsWith('/') || path.split('/').pop().includes('.'))
          return '';
        const segment = path.split('/').pop();
        return segment ? segment + '/' : '';
      }

      async function apiGet(path) {
        const prefix = getApiPrefix();
        const r = await fetch(prefix + path, { cache: 'no-store' });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.error || `HTTP ${r.status}`);
        return j;
      }

      async function apiSend(path, method, body) {
        const prefix = getApiPrefix();
        const r = await fetch(prefix + path, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: body ? JSON.stringify(body) : undefined,
        });
        const j = await r.json().catch(() => ({}));
        if (!r.ok) throw new Error(j.error || `HTTP ${r.status}`);
        return j;
      }

      async function resolveWebApiBase() {
        if (state.webApiBase) return state.webApiBase;
        const publishPath = 'api/admin/scraper/publish-sanity';
        const proto = location.protocol;
        const host = location.hostname;
        const candidates = [];
        if (location.port === '3000' || location.port === '3001')
          candidates.push('');
        candidates.push(`${proto}//${host}:3000`);
        candidates.push(`${proto}//${host}:3001`);
        candidates.push(`${proto}//${host}:3002`);
        for (const base of candidates) {
          const url = base
            ? `${base}/${publishPath}`
            : getApiPrefix() + publishPath;
          try {
            const r = await fetch(url, { method: 'OPTIONS' });
            if (r.ok) {
              state.webApiBase = base;
              return base;
            }
          } catch {
            continue;
          }
        }
        state.webApiBase = `${proto}//${host}:3000`;
        return state.webApiBase;
      }

      function safeJsonParse(text) {
        try {
          return JSON.parse(text);
        } catch {
          return null;
        }
      }

      function normalizeTarget(t) {
        const baseUrl = String(t?.baseUrl || t?.base_url || '').trim();
        const pageLimit = Number.isFinite(Number(t?.pageLimit ?? t?.page_limit))
          ? Number(t.pageLimit ?? t.page_limit)
          : 1;
        const query = String(t?.query || '').trim();
        const mode = String(t?.mode || 'scrape')
          .trim()
          .toLowerCase();
        const useSelenium = !!(t?.useSelenium ?? t?.use_selenium);
        const autoPublish = !!t?.autoPublish;
        const maxPosts = Number.isFinite(Number(t?.maxPosts ?? t?.max_posts))
          ? Number(t.maxPosts ?? t.max_posts)
          : 0;
        const scrapeOrder = String(t?.scrapeOrder || t?.scrape_order || 'asc')
          .trim()
          .toLowerCase();
        const config =
          typeof t?.config === 'object' && t?.config
            ? t.config
            : typeof t === 'object' && t
              ? t.pagination || t.listing || t.details
                ? {
                    pagination: t.pagination,
                    listing: t.listing,
                    details: t.details,
                  }
                : {}
              : {};
        return {
          baseUrl,
          pageLimit,
          query,
          mode,
          useSelenium,
          autoPublish,
          maxPosts,
          scrapeOrder,
          config,
        };
      }

      function mergeConfig(baseConfig, overrideConfig) {
        const base =
          baseConfig && typeof baseConfig === 'object' ? baseConfig : {};
        const over =
          overrideConfig && typeof overrideConfig === 'object'
            ? overrideConfig
            : {};
        const out = { ...base, ...over };
        const keys = ['pagination', 'listing', 'details'];
        for (const k of keys) {
          const a = base[k] && typeof base[k] === 'object' ? base[k] : {};
          const b = over[k] && typeof over[k] === 'object' ? over[k] : {};
          const merged = { ...a, ...b };
          if (Object.keys(merged).length) out[k] = merged;
        }
        return out;
      }

      function targetsFromPreset(preset) {
        const p = preset && typeof preset === 'object' ? preset : {};
        const baseConfig = {
          pagination: p.pagination || {},
          listing: p.listing || {},
          details: p.details || {},
        };
        const rec = Array.isArray(p.recommendedTargets)
          ? p.recommendedTargets
          : [];
        return rec
          .map((t) => {
            const n = normalizeTarget(t);
            n.config = mergeConfig(baseConfig, n.config || {});
            return n;
          })
          .filter((t) => t.baseUrl);
      }

      function targetLabel(t) {
        try {
          const u = new URL(t.baseUrl);
          return u.hostname;
        } catch {
          return t.baseUrl || 'target';
        }
      }

      function renderPresets() {
        const select = el('presetSelect');
        if (!select) return;
        select.innerHTML = '';
        for (const p of state.presets) {
          const opt = document.createElement('option');
          opt.value = p.id || '';
          opt.textContent = p.label || p.id || 'preset';
          select.appendChild(opt);
        }
        if (state.presets.length && !state.selectedPresetId) {
          state.selectedPresetId = state.presets[0].id;
        }
        if (state.selectedPresetId) select.value = state.selectedPresetId;
      }

      function renderTargets() {
        const grid = el('targetsGrid');
        const meta = el('targetsMeta');
        if (meta) meta.textContent = `${state.targets.length} target(s)`;
        if (!grid) return;
        grid.innerHTML = '';
        for (let i = 0; i < state.targets.length; i++) {
          const t = state.targets[i];
          const card = document.createElement('div');
          card.className =
            'glass-card group relative overflow-hidden rounded-3xl border border-slate-800 p-6 transition hover:border-indigo-500/30';
          card.innerHTML = `
            <div class="mb-5 flex items-start justify-between gap-4">
              <div class="min-w-0">
                <div class="truncate text-lg font-black text-white">${targetLabel(t)}</div>
                <div class="mt-1 truncate font-mono text-[10px] text-slate-500">${t.baseUrl || ''}</div>
              </div>
              <span class="rounded bg-slate-800 px-2 py-1 text-[10px] font-black uppercase tracking-widest text-slate-200">${(t.mode || 'scrape').toUpperCase()}</span>
            </div>
            <div class="space-y-2 rounded-2xl border border-slate-900 bg-slate-950/40 p-4 text-xs">
              <div class="flex justify-between"><span class="text-slate-500">Pages</span><span class="font-bold text-indigo-400">${t.pageLimit || 1}</span></div>
              <div class="flex justify-between"><span class="text-slate-500">Max Posts</span><span class="font-bold text-indigo-400">${t.maxPosts || 0}</span></div>
              <div class="flex justify-between"><span class="text-slate-500">Order</span><span class="font-bold text-indigo-400">${t.scrapeOrder || 'asc'}</span></div>
              <div class="flex justify-between"><span class="text-slate-500">Selenium</span><span class="font-bold text-indigo-400">${t.useSelenium ? 'On' : 'Off'}</span></div>
            </div>
            <div class="mt-5 flex gap-2">
              <button data-action="run" class="flex-1 rounded-xl bg-emerald-600/10 py-3 text-xs font-bold text-emerald-400 transition hover:bg-emerald-600 hover:text-white">
                <i class="fas fa-play mr-2"></i>RUN
              </button>
              <button data-action="edit" class="flex-1 rounded-xl bg-slate-800 py-3 text-xs font-bold transition hover:bg-slate-700">
                EDIT
              </button>
              <button data-action="delete" class="rounded-xl bg-rose-600/10 p-3 text-rose-500 transition hover:bg-rose-600 hover:text-white">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          card
            .querySelector('[data-action="run"]')
            .addEventListener('click', () => runTargets([t]));
          card
            .querySelector('[data-action="edit"]')
            .addEventListener('click', () => openTargetModal(i));
          card
            .querySelector('[data-action="delete"]')
            .addEventListener('click', () => deleteTarget(i));
          grid.appendChild(card);
        }
      }

      function openTargetModal(index) {
        state.editingTargetIndex = typeof index === 'number' ? index : null;
        const t =
          typeof index === 'number' && state.targets[index]
            ? state.targets[index]
            : normalizeTarget({
                baseUrl: '',
                pageLimit: 1,
                mode: 'scrape',
                maxPosts: 0,
                query: '',
                scrapeOrder: 'asc',
              });
        el('targetBaseUrlInput').value = t.baseUrl || '';
        el('targetPageLimitInput').value = t.pageLimit || 1;
        el('targetMaxPostsInput').value = t.maxPosts || '';
        el('targetScrapeOrderSelect').value = t.scrapeOrder || 'asc';
        el('targetNameInput').value = targetLabel(t) || '';
        el('targetUseSeleniumToggle').checked = !!t.useSelenium;
        el('targetAutoPublishToggle').checked = !!t.autoPublish;
        el('targetConfigTextarea').value = JSON.stringify(
          t.config || {},
          null,
          2,
        );
        if (el('targetScheduleSelect'))
          el('targetScheduleSelect').value = 'none';
        fillPaginationFieldsFromConfig();
        toggleModal('targetModal', true);
      }

      function fillPaginationFieldsFromConfig() {
        const raw = String(el('targetConfigTextarea')?.value || '');
        const cfg = safeJsonParse(raw) || {};
        const pg =
          cfg.pagination && typeof cfg.pagination === 'object'
            ? cfg.pagination
            : {};
        const mode = String(pg.mode || pg.type || '')
          .trim()
          .toLowerCase();
        const normalizedMode =
          mode === 'kvs-ajax' || mode === 'ajax' || mode === 'kvs_ajax'
            ? 'kvs_ajax'
            : '';
        el('paginationModeSelect').value = normalizedMode;
        el('paginationPage1Input').value = String(pg.page1 || '');
        el('paginationPageNInput').value = String(pg.pageN || pg.page_n || '');
        el('ajaxPaginationSelectorInput').value = String(
          pg.paginationSelector ||
            pg.pagination_selector ||
            pg.ajaxLinkSelector ||
            pg.ajax_link_selector ||
            '',
        );
        el('ajaxPaginationNextSelectorInput').value = String(
          pg.nextSelector ||
            pg.next_selector ||
            pg.ajaxNextSelector ||
            pg.ajax_next_selector ||
            '',
        );
        const isAjax = normalizedMode === 'kvs_ajax';
        el('ajaxPaginationFields')?.classList.toggle('hidden', !isAjax);
      }

      function applyPaginationFieldsToConfig(notifyError = true) {
        const raw = String(el('targetConfigTextarea')?.value || '');
        const parsed = safeJsonParse(raw);
        if (raw.trim() && !parsed) {
          if (notifyError)
            notify('Invalid JSON in Advanced Selectors', 'error');
          return false;
        }
        const cfg = parsed || {};
        const pagination =
          cfg.pagination && typeof cfg.pagination === 'object'
            ? cfg.pagination
            : {};
        const mode = String(el('paginationModeSelect')?.value || '').trim();
        const page1 = String(el('paginationPage1Input')?.value || '').trim();
        const pageN = String(el('paginationPageNInput')?.value || '').trim();
        const ajaxSel = String(
          el('ajaxPaginationSelectorInput')?.value || '',
        ).trim();
        const ajaxNext = String(
          el('ajaxPaginationNextSelectorInput')?.value || '',
        ).trim();

        if (mode) pagination.mode = mode;
        else delete pagination.mode;

        if (page1) pagination.page1 = page1;
        else delete pagination.page1;

        if (pageN) pagination.pageN = pageN;
        else delete pagination.pageN;

        if (ajaxSel) pagination.paginationSelector = ajaxSel;
        else delete pagination.paginationSelector;

        if (ajaxNext) pagination.nextSelector = ajaxNext;
        else delete pagination.nextSelector;

        cfg.pagination = pagination;
        el('targetConfigTextarea').value = JSON.stringify(cfg, null, 2);
        fillPaginationFieldsFromConfig();
        return true;
      }

      async function saveTargetFromModal() {
        const baseUrl = String(el('targetBaseUrlInput').value || '').trim();
        if (!baseUrl) {
          notify('Base URL is required', 'error');
          return;
        }
        if (!applyPaginationFieldsToConfig(true)) return;
        const config =
          safeJsonParse(el('targetConfigTextarea').value || '') || {};
        const t = normalizeTarget({
          baseUrl,
          pageLimit: el('targetPageLimitInput').value,
          maxPosts: el('targetMaxPostsInput').value,
          scrapeOrder: el('targetScrapeOrderSelect').value,
          useSelenium: el('targetUseSeleniumToggle').checked,
          autoPublish: el('targetAutoPublishToggle').checked,
          config,
        });

        // Check if a target with this Base URL already exists
        const existingIndex = state.targets.findIndex(
          (x) => x.baseUrl === t.baseUrl,
        );

        if (state.editingTargetIndex !== null) {
          // Editing mode
          if (
            existingIndex >= 0 &&
            existingIndex !== state.editingTargetIndex
          ) {
            // Collision: Merging into another existing target
            state.targets[existingIndex] = {
              ...state.targets[existingIndex],
              ...t,
            };
            state.targets.splice(state.editingTargetIndex, 1);
            notify('Merged into existing target with same URL', 'success');
          } else {
            // Normal update
            state.targets[state.editingTargetIndex] = {
              ...state.targets[state.editingTargetIndex],
              ...t,
            };
          }
        } else if (existingIndex >= 0) {
          // New mode, but URL exists -> Update existing
          state.targets[existingIndex] = {
            ...state.targets[existingIndex],
            ...t,
          };
          notify('Updated existing target with same URL', 'success');
        } else {
          // New mode, unique URL -> Create new
          state.targets.unshift(t);
        }

        const sched = String(el('targetScheduleSelect')?.value || 'none');
        if (sched !== 'none') {
          const map = {
            '15m': 15 * 60,
            '30m': 30 * 60,
            '1h': 60 * 60,
            '2h': 2 * 60 * 60,
            '6h': 6 * 60 * 60,
            '12h': 12 * 60 * 60,
            '24h': 24 * 60 * 60,
          };
          const intervalSeconds = map[sched];
          if (intervalSeconds) {
            try {
              await apiSend('api/jobs', 'POST', {
                name: String(el('targetNameInput')?.value || targetLabel(t)),
                intervalSeconds,
                targets: [t],
              });
              await refreshJobs();
            } catch (e) {
              notify(String(e.message || e), 'error');
            }
          }
        }

        toggleModal('targetModal', false);
        state.editingTargetIndex = null;
        renderTargets();
        notify('Target saved', 'success');
      }

      function deleteTarget(index) {
        state.targets.splice(index, 1);
        renderTargets();
        notify('Target removed', 'success');
      }

      async function runTargets(targets) {
        if (!targets || targets.length === 0) {
          notify('No targets to run', 'error');
          return;
        }
        try {
          const r = await apiSend('api/runs', 'POST', { targets });
          const runId = r?.data?.runId || '';
          if (runId) state.selectedRunId = runId;
          notify(runId ? `Run accepted ${runId}` : 'Run accepted', 'success');
          switchTab('active-runs');
          await refreshRuns();
          await refreshProgress();
          await refreshLog();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      async function runAllTargets(ev) {
        const btn = ev?.currentTarget;
        const original = btn?.innerHTML;
        if (btn) {
          btn.disabled = true;
          btn.innerHTML =
            '<i class="fas fa-circle-notch fa-spin mr-2"></i> STARTING...';
        }
        try {
          await runTargets(state.targets);
        } finally {
          if (btn) {
            btn.disabled = false;
            btn.innerHTML =
              original || '<i class="fas fa-play mr-2"></i> RUN ALL TARGETS';
          }
        }
      }

      function renderSchedules() {
        const grid = el('schedulesGrid');
        if (!grid) return;
        grid.innerHTML = '';
        for (const j of state.jobs) {
          const jobId = j.id;
          const enabled = !!j.enabled;
          const interval = j.interval_seconds;
          const freq =
            interval && Number(interval) > 0
              ? `Every ${Math.round(Number(interval) / 60)} Minutes`
              : j.run_at
                ? `At ${j.run_at}`
                : 'Manual';
          const card = document.createElement('div');
          card.className =
            'glass-card group relative rounded-3xl border border-slate-800 p-6';
          card.innerHTML = `
            <div class="mb-6 flex items-start justify-between">
              <div class="flex h-12 w-12 items-center justify-center rounded-2xl bg-indigo-600/10 text-indigo-500">
                <i class="fas fa-clock text-xl"></i>
              </div>
              <div class="text-right">
                <span class="rounded ${enabled ? 'bg-emerald-500/10 text-emerald-500' : 'bg-slate-800 text-slate-300'} px-2 py-1 text-[10px] font-black uppercase tracking-widest">
                  ${enabled ? 'Enabled' : 'Disabled'}
                </span>
              </div>
            </div>
            <h4 class="truncate text-lg font-bold">${j.name || jobId}</h4>
            <div class="mt-4 space-y-3 rounded-2xl border border-slate-900 bg-slate-950 p-4">
              <div class="flex justify-between text-xs">
                <span class="text-slate-500">Frequency</span>
                <span class="font-bold text-indigo-400">${freq}</span>
              </div>
              <div class="flex justify-between text-xs">
                <span class="text-slate-500">Next Run</span>
                <span class="truncate pl-4 text-slate-300">${j.next_run_at || '-'}</span>
              </div>
            </div>
            <div class="mt-6 flex gap-2">
              <button data-action="run" class="flex-1 rounded-xl bg-emerald-600/10 py-3 text-xs font-bold text-emerald-400 transition hover:bg-emerald-600 hover:text-white">
                <i class="fas fa-play mr-2"></i>RUN
              </button>
              <button data-action="delete" class="rounded-xl bg-rose-600/10 p-3 text-rose-500 transition hover:bg-rose-600 hover:text-white">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          card
            .querySelector('[data-action="run"]')
            .addEventListener('click', () => runJob(jobId));
          card
            .querySelector('[data-action="delete"]')
            .addEventListener('click', () => deleteJob(jobId));
          grid.appendChild(card);
        }
      }

      async function refreshJobs() {
        try {
          const r = await apiGet('api/jobs');
          state.jobs = r.data || [];
          renderSchedules();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      async function runJob(jobId) {
        try {
          const r = await apiSend(
            `api/jobs/${encodeURIComponent(jobId)}/run`,
            'POST',
            {},
          );
          const runId = r?.data?.runId || '';
          if (runId) state.selectedRunId = runId;
          notify(
            runId ? `Job run accepted ${runId}` : 'Job run accepted',
            'success',
          );
          switchTab('active-runs');
          await refreshRuns();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      async function deleteJob(jobId) {
        try {
          await apiSend(`api/jobs/${encodeURIComponent(jobId)}`, 'DELETE');
          notify('Job deleted', 'success');
          await refreshJobs();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      function renderRunsSelect() {
        const sel = el('resultsRunSelect');
        if (!sel) return;
        sel.innerHTML = '';
        for (const r of state.runs) {
          const opt = document.createElement('option');
          opt.value = r.id;
          opt.textContent = `${r.status || 'run'} Â· ${r.id}`;
          sel.appendChild(opt);
        }
        if (!state.selectedRunId && state.runs.length)
          state.selectedRunId = state.runs[0].id;
        if (state.selectedRunId) sel.value = state.selectedRunId;
        updatePublishUi();
      }

      async function refreshRuns() {
        try {
          const r = await apiGet('api/runs');
          state.runs = r.data || [];
          renderRunsSelect();
          renderRecentRuns();
          if (state.selectedRunId) await loadRunPosts(state.selectedRunId);
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      function extractPostsFromRun(run) {
        const result = run?.result;
        if (!result || typeof result !== 'object') return [];
        const targets = result.targets;
        if (!Array.isArray(targets)) return [];
        const posts = [];
        for (const t of targets) {
          if (t && Array.isArray(t.posts)) posts.push(...t.posts);
        }
        return posts;
      }

      function renderResultsGrid() {
        const grid = el('resultsGrid');
        const meta = el('resultsMeta');
        if (!grid) return;
        const posts = state.selectedRunPosts || [];
        if (meta)
          meta.innerHTML = `<i class="fas fa-info-circle mr-1"></i> Showing ${posts.length} results`;
        grid.innerHTML = '';
        for (const p of posts) {
          const title = String(p.title || p.caption || 'Untitled');
          const link = String(p.link || '');
          const imageUrl = String(p.image_url || '');
          let sourceLabel = '';
          try {
            sourceLabel = link ? new URL(link).hostname : '';
          } catch {
            sourceLabel = '';
          }
          sourceLabel = (
            sourceLabel ||
            String(p.baseUrl || '') ||
            'source'
          ).toUpperCase();
          const description = String(
            p.meta_description || p.og_description || '',
          ).trim();
          const tags = Array.isArray(p.slinks_texts)
            ? p.slinks_texts.slice(0, 6)
            : [];
          const card = document.createElement('div');
          card.dataset.link = link;
          card.className =
            'glass-card post-card group overflow-hidden rounded-3xl border border-slate-800 transition-all duration-300 hover:border-indigo-500/50';
          card.innerHTML = `
            <div class="relative h-48 overflow-hidden bg-slate-950">
              ${imageUrl ? `<img src="${imageUrl}" alt="post" class="h-full w-full object-cover transition duration-500 group-hover:scale-110" />` : `<div class="flex h-full w-full items-center justify-center text-xs text-slate-600">No thumbnail</div>`}
              <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
              <div class="absolute bottom-4 left-4 right-4">
                <span class="mb-2 inline-block rounded bg-indigo-600 px-2 py-1 text-[10px] font-black">${sourceLabel}</span>
                ${p.published ? '<span class="mb-2 ml-1 inline-block rounded bg-emerald-600 px-2 py-1 text-[10px] font-black text-white">PUBLISHED</span>' : ''}
                <h4 class="line-clamp-2 text-sm font-bold text-white">${title}</h4>
              </div>
            </div>
            <div class="space-y-3 p-5">
              <p class="line-clamp-2 text-xs italic text-slate-400">${description || ''}</p>
              <div class="flex flex-wrap gap-1">
                ${tags.map((t) => `<span class="rounded-full bg-slate-800 px-2 py-0.5 text-[9px] text-slate-400">${String(t)}</span>`).join('')}
              </div>
              <div class="flex items-center justify-between border-t border-slate-800 pt-3 font-mono text-[10px]">
                <span class="text-slate-500">${p.fetchedAt || ''}</span>
                ${link ? `<a href="${link}" target="_blank" rel="noopener noreferrer" class="text-indigo-400 hover:underline">View Source <i class="fas fa-external-link-alt ml-1"></i></a>` : `<span class="text-slate-600">No link</span>`}
              </div>
            </div>
          `;
          grid.appendChild(card);
        }
      }

      function updatePublishedBadges(links) {
        const grid = el('resultsGrid');
        if (!grid) return;
        const linkSet = new Set(links);
        const cards = grid.children;
        for (let i = 0; i < cards.length; i++) {
          const card = cards[i];
          if (linkSet.has(card.dataset.link)) {
            const labelContainer = card.querySelector('.absolute.bottom-4');
            if (
              labelContainer &&
              !labelContainer.querySelector('.bg-emerald-600')
            ) {
              const badge = document.createElement('span');
              badge.className =
                'mb-2 ml-1 inline-block rounded bg-emerald-600 px-2 py-1 text-[10px] font-black text-white';
              badge.textContent = 'PUBLISHED';
              const sourceLabel = labelContainer.querySelector('span');
              if (sourceLabel) sourceLabel.after(badge);
              else labelContainer.prepend(badge);
            }
          }
        }
      }

      async function loadRunPosts(runId) {
        if (!runId) return;
        try {
          const r = await apiGet(`api/runs/${encodeURIComponent(runId)}`);
          state.selectedRunId = runId;
          state.selectedRunPosts = extractPostsFromRun(r.data);
          renderResultsGrid();
          updatePublishUi();
        } catch (e) {
          state.selectedRunPosts = [];
          renderResultsGrid();
          updatePublishUi();
        }
      }

      function getSelectedRunMeta() {
        const runId = state.selectedRunId;
        const run = state.runs.find((x) => x.id === runId);
        return run || null;
      }

      function getPublishablePosts() {
        const posts = state.selectedRunPosts || [];
        const out = [];
        for (const p of posts) {
          if (!p || !p.link) continue;
          if (p.published) continue;
          const v = p.video_src || p.video_url;
          if (!v) continue;
          out.push(p);
        }
        return out;
      }

      function renderPublishTasks() {
        const container = el('publishTasksContainer');
        const panel = el('publishPanel');
        if (!container) return;
        const tasks = state.publishTasks || [];

        if (panel) {
          panel.classList.toggle('hidden', tasks.length === 0);
        }

        if (tasks.length === 0) {
          container.innerHTML = '';
          return;
        }
        container.innerHTML = tasks
          .map((task) => {
            const pct = Math.max(0, Math.min(100, task.percent || 0));
            const color =
              task.status === 'failed'
                ? 'bg-rose-500'
                : task.status === 'completed'
                  ? 'bg-emerald-500'
                  : 'bg-indigo-500';
            return `
            <div class="glass-card rounded-2xl border border-slate-800 p-4">
                <div class="flex items-center justify-between mb-2">
                    <div class="text-xs font-bold text-white">Publishing to Sanity (Run: ${task.runId})</div>
                    <div class="text-[10px] uppercase font-black text-slate-500">${task.status}</div>
                </div>
                <div class="h-1.5 w-full bg-slate-900 rounded-full overflow-hidden mb-2">
                    <div class="h-full ${color} transition-all duration-300" style="width: ${pct}%"></div>
                </div>
                <div class="flex justify-between text-[10px] font-mono text-slate-400">
                   <span>${task.resultText || ''}</span>
                   <span>${pct}%</span>
                </div>
                ${
                  task.failedSamples && task.failedSamples.length
                    ? `
                <div class="mt-2 text-[10px] text-rose-400 max-h-20 overflow-y-auto custom-scrollbar bg-black/20 p-2 rounded">
                    ${task.failedSamples.map((x) => `<div>${x.link}: ${x.error}</div>`).join('')}
                </div>`
                    : ''
                }
            </div>`;
          })
          .join('');
      }

      function renderRecentRuns() {
        const list = el('recentRunsList');
        if (!list) return;
        const runs = state.runs || [];
        if (runs.length === 0) {
          list.innerHTML =
            '<div class="text-center text-slate-500 text-xs py-4">No recent runs</div>';
          return;
        }
        list.innerHTML = runs
          .slice(0, 20)
          .map((run) => {
            const status = (run.status || 'unknown').toLowerCase();
            const color =
              status === 'succeeded'
                ? 'text-emerald-400'
                : status === 'failed'
                  ? 'text-rose-400'
                  : status === 'running'
                    ? 'text-indigo-400'
                    : status === 'queued'
                      ? 'text-amber-400'
                      : 'text-slate-400';
            const borderColor =
              status === 'running'
                ? 'border-indigo-500/50'
                : status === 'queued'
                  ? 'border-amber-500/50'
                  : 'border-slate-800';
            return `
            <div class="glass-card rounded-2xl border ${borderColor} p-4 flex items-center justify-between transition hover:bg-slate-800/50 cursor-pointer mb-2" onclick="loadRunPosts('${run.id}'); switchTab('results');">
                <div>
                    <div class="text-xs font-mono text-slate-500 mb-1">RUN: ${run.id}</div>
                    <div class="text-sm font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full ${status === 'running' ? 'bg-indigo-500 animate-pulse' : status === 'succeeded' ? 'bg-emerald-500' : status === 'queued' ? 'bg-amber-500 animate-pulse' : 'bg-slate-600'}"></span>
                        ${status.toUpperCase()}
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-slate-500">${run.started_at || ''}</div>
                    <div class="text-xs font-bold ${color}">${status}</div>
                </div>
             </div>
             `;
          })
          .join('');
      }

      function setPublishPanel({
        show,
        running,
        statusText,
        resultText,
        percent,
        failedSamples,
      }) {
        const panel = el('publishPanel');
        if (!panel) return;
        panel.classList.toggle('hidden', !show);
        el('publishSpinner')?.classList.toggle('hidden', !running);
        el('publishStatusText').textContent = statusText || '';
        el('publishResultText').textContent = resultText || '';
        const bar = el('publishBar');
        if (bar)
          bar.style.width = `${Math.max(0, Math.min(100, percent || 0))}%`;

        const list = el('publishFailedList');
        if (list) {
          const items = Array.isArray(failedSamples) ? failedSamples : [];
          list.classList.toggle('hidden', items.length === 0);
          if (items.length) {
            list.textContent = items
              .map((x) => `${String(x.link || '')}\n  ${String(x.error || '')}`)
              .join('\n\n');
          } else {
            list.textContent = '';
          }
        }
      }

      function updatePublishUi() {
        const btn = el('publishSanityBtn');
        if (!btn) return;
        const run = getSelectedRunMeta();
        const status = String(run?.status || '').toLowerCase();
        const canPublish = status === 'succeeded';

        const isPublishing = (state.publishTasks || []).some(
          (t) => t.runId === state.selectedRunId && t.status === 'running',
        );

        btn.classList.toggle('hidden', !canPublish);
        btn.disabled = !canPublish || isPublishing;
        btn.classList.toggle('opacity-40', !canPublish || isPublishing);
        btn.classList.toggle('cursor-not-allowed', !canPublish || isPublishing);
      }

      async function publishToSanity() {
        const run = getSelectedRunMeta();
        const status = String(run?.status || '').toLowerCase();
        if (status !== 'succeeded') {
          notify('Select a succeeded run first', 'error');
          return;
        }
        const publishable = getPublishablePosts();
        if (!publishable.length) {
          notify('No new publishable posts found', 'error');
          return;
        }

        const publishPath = 'api/admin/scraper/publish-sanity';
        const base = await resolveWebApiBase();
        const publishUrl = base ? `${base}/${publishPath}` : publishPath;

        if (!state.publishTasks) state.publishTasks = [];
        const task = {
          id: Date.now(),
          runId: state.selectedRunId,
          status: 'running',
          percent: 0,
          resultText: `Starting publish for ${publishable.length} posts...`,
          failedSamples: [],
        };
        state.publishTasks.unshift(task);
        renderPublishTasks();
        updatePublishUi();
        notify('Publishing started in background...', 'success');

        const BATCH_SIZE = 10;
        let processed = 0;
        let postedTotal = 0;
        let skippedTotal = 0;
        let failedTotal = 0;
        const total = publishable.length;
        const allFailedSamples = [];

        try {
          for (let i = 0; i < total; i += BATCH_SIZE) {
            if (task.status === 'failed' || task.status === 'canceled') break;

            const chunk = publishable.slice(i, i + BATCH_SIZE);
            task.resultText = `Publishing ${i + 1}-${Math.min(i + BATCH_SIZE, total)} of ${total} posts...`;
            renderPublishTasks();

            try {
              const r = await apiSend(publishUrl, 'POST', {
                posts: chunk,
                runId: state.selectedRunId,
              });
              const d = r.data || {};
              const p = Number(d.posted || 0);
              const s = Number(d.skipped || 0);
              const f = Number(d.failed || 0);
              const fs = d.failedSamples || [];
              const postedLinks = Array.isArray(d.postedLinks)
                ? d.postedLinks
                : [];

              postedTotal += p;
              skippedTotal += s;
              failedTotal += f;
              if (fs.length) allFailedSamples.push(...fs);

              const linksToMark =
                postedLinks.length > 0
                  ? postedLinks
                  : p > 0
                    ? chunk.map((p) => p.link)
                    : [];

              if (linksToMark.length > 0) {
                if (state.selectedRunId === task.runId) {
                  const localPosts = state.selectedRunPosts || [];
                  const linkSet = new Set(linksToMark);
                  for (const p of localPosts) {
                    if (linkSet.has(p.link)) p.published = true;
                  }
                  updatePublishedBadges(linksToMark);
                }

                await apiSend(
                  `api/runs/${encodeURIComponent(task.runId)}/mark-published`,
                  'POST',
                  {
                    links: linksToMark,
                  },
                );
              }
            } catch (e) {
              failedTotal += chunk.length;
              allFailedSamples.push({
                link: 'batch_error',
                error: String(e.message || e),
              });
            }

            processed += chunk.length;
            task.percent = Math.floor((processed / total) * 100);
            task.failedSamples = allFailedSamples.slice(0, 20);
            renderPublishTasks();
          }

          task.status =
            failedTotal === total && total > 0 ? 'failed' : 'completed';
          task.percent = 100;
          task.resultText = `Posted: ${postedTotal}, Skipped: ${skippedTotal}, Failed: ${failedTotal}`;
          task.failedSamples = allFailedSamples;
          renderPublishTasks();

          notify(
            `Publish finished: ${postedTotal} posted`,
            failedTotal ? 'warning' : 'success',
          );
        } catch (e) {
          task.status = 'failed';
          task.resultText = String(e.message || e);
          task.percent = 0;
          notify(`Publish failed: ${e.message}`, 'error');
        } finally {
          renderPublishTasks();
          updatePublishUi();
        }
      }

      function downloadCsv() {
        const posts = state.selectedRunPosts || [];
        const headers = [
          'title',
          'link',
          'video_src',
          'image_url',
          'meta_description',
          'og_title',
          'og_description',
        ];
        const esc = (v) => `"${String(v ?? '').replace(/"/g, '""')}"`;
        const rows = [headers.join(',')];
        for (const p of posts) {
          rows.push(headers.map((h) => esc(p[h])).join(','));
        }
        const blob = new Blob([rows.join('\n')], {
          type: 'text/csv;charset=utf-8',
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `run_${state.selectedRunId || 'results'}.csv`;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      async function deleteSelectedRun() {
        if (!state.selectedRunId) return;
        try {
          await apiSend(
            `api/runs/${encodeURIComponent(state.selectedRunId)}`,
            'DELETE',
          );
          notify('Run deleted', 'success');
          state.selectedRunId = '';
          state.selectedRunPosts = [];
          await refreshRuns();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      async function refreshProgress() {
        try {
          const r = await apiGet('progress');
          const pr = r.data || {};
          const running = !!pr.running;
          const runId = String(pr.runId || state.selectedRunId || '');
          const baseUrl = String(pr.baseUrl || pr.base_url || '');
          el('liveBaseUrl').textContent = baseUrl
            ? targetLabel({ baseUrl })
            : 'Idle';
          el('liveRunId').textContent = runId ? `RUN_ID: ${runId}` : '';
          el('liveStatus').textContent = running
            ? String(pr.phase || 'running').replace(/_/g, ' ')
            : 'Idle';
          el('livePing').classList.toggle('hidden', !running);
          const pagesCompleted = Number(
            pr.pagesCompleted ?? pr.pages_completed ?? pr.page ?? 0,
          );
          const pageLimit = Number(
            pr.pageLimit ??
              pr.page_limit ??
              pr.pagesTarget ??
              pr.page_limit ??
              0,
          );
          const pct =
            pageLimit > 0
              ? Math.max(
                  0,
                  Math.min(100, Math.round((pagesCompleted / pageLimit) * 100)),
                )
              : running
                ? 1
                : 0;
          el('livePercent').textContent = `${pct}%`;
          el('liveBar').style.width = `${pct}%`;
          el('livePageText').textContent =
            pageLimit > 0 ? `Page ${pagesCompleted} of ${pageLimit}` : '';
          el('livePhaseText').textContent = pr.phase
            ? `Phase: ${String(pr.phase).replace(/_/g, ' ')}`
            : '';
          el('liveProcessed').textContent = String(
            pr.postsProcessed ??
              pr.posts_processed ??
              pr.postsFound ??
              pr.posts_found ??
              0,
          );
          el('liveNewItems').textContent = String(
            pr.newItems ?? pr.new_items ?? '-',
          );
          el('liveSkipped').textContent = String(
            pr.skipped ?? pr.skippedCount ?? 0,
          );
          el('liveCurrentUrl').textContent = String(
            pr.currentPostUrl || pr.current_url || pr.url || '',
          );
          if (!runId) {
            el('stopRunBtn').classList.add('opacity-40');
          } else {
            el('stopRunBtn').classList.remove('opacity-40');
          }
        } catch {
          el('liveBaseUrl').textContent = 'Idle';
          el('liveRunId').textContent = '';
          el('liveStatus').textContent = 'Idle';
          el('livePing').classList.add('hidden');
          el('livePercent').textContent = '0%';
          el('liveBar').style.width = '0%';
          el('livePageText').textContent = '';
          el('livePhaseText').textContent = '';
          el('liveProcessed').textContent = '0';
          el('liveNewItems').textContent = '-';
          el('liveSkipped').textContent = '0';
          el('liveCurrentUrl').textContent = '';
        }
      }

      async function refreshLog() {
        try {
          const prefix = getApiPrefix();
          const r = await fetch(prefix + 'scraper-live.log', {
            cache: 'no-store',
          });
          el('liveLog').textContent = await r.text();
        } catch {
          el('liveLog').textContent = '';
        }
      }

      async function stopCurrentRun() {
        try {
          const pr = await apiGet('progress');
          const runId = String(
            pr?.data?.runId || state.selectedRunId || '',
          ).trim();
          if (!runId) {
            notify('No active runId to stop', 'error');
            return;
          }
          await apiSend(
            `api/runs/${encodeURIComponent(runId)}/stop`,
            'POST',
            {},
          );
          notify(`Stop requested ${runId}`, 'success');
          await refreshProgress();
          await refreshRuns();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
      }

      async function importPresetFromModal() {
        const raw = String(el('importPresetTextarea')?.value || '').trim();
        if (!raw) {
          notify('Paste JSON first', 'error');
          return;
        }
        const parsed = safeJsonParse(raw);
        if (!parsed) {
          notify('Invalid JSON', 'error');
          return;
        }
        let targets = [];
        if (Array.isArray(parsed)) targets = parsed;
        else if (Array.isArray(parsed.targets)) targets = parsed.targets;
        else if (Array.isArray(parsed.recommendedTargets))
          targets = parsed.recommendedTargets;
        else if (Array.isArray(parsed.data)) targets = parsed.data;
        state.targets = (targets || [])
          .map(normalizeTarget)
          .filter((t) => t.baseUrl);
        if (state.targets.length === 0) state.targets = [];
        renderTargets();
        toggleModal('importModal', false);
        notify('Configuration imported', 'success');
      }

      function attachHandlers() {
        el('loadPresetBtn')?.addEventListener('click', () => {
          const presetId = String(el('presetSelect')?.value || '').trim();
          state.selectedPresetId = presetId;
          const p = state.presets.find((x) => x.id === presetId);
          const newTargets = targetsFromPreset(p);

          let added = 0;
          let updated = 0;

          for (const t of newTargets) {
            const idx = state.targets.findIndex((x) => x.baseUrl === t.baseUrl);
            if (idx >= 0) {
              state.targets[idx] = { ...state.targets[idx], ...t };
              updated++;
            } else {
              state.targets.push(t);
              added++;
            }
          }

          renderTargets();
          notify(
            `Preset loaded: ${added} added, ${updated} updated`,
            'success',
          );
        });

        el('importPresetBtn')?.addEventListener('click', () =>
          toggleModal('importModal', true),
        );
        el('applyImportBtn')?.addEventListener('click', importPresetFromModal);
        el('saveTargetBtn')?.addEventListener('click', saveTargetFromModal);
        el('stopRunBtn')?.addEventListener('click', stopCurrentRun);
        el('reloadLogBtn')?.addEventListener('click', refreshLog);
        el('downloadCsvBtn')?.addEventListener('click', downloadCsv);
        el('deleteRunBtn')?.addEventListener('click', deleteSelectedRun);
        el('publishSanityBtn')?.addEventListener('click', publishToSanity);
        el('paginationModeSelect')?.addEventListener('change', () =>
          applyPaginationFieldsToConfig(false),
        );
        el('paginationPage1Input')?.addEventListener('input', () =>
          applyPaginationFieldsToConfig(false),
        );
        el('paginationPageNInput')?.addEventListener('input', () =>
          applyPaginationFieldsToConfig(false),
        );
        el('ajaxPaginationSelectorInput')?.addEventListener('input', () =>
          applyPaginationFieldsToConfig(false),
        );
        el('ajaxPaginationNextSelectorInput')?.addEventListener('input', () =>
          applyPaginationFieldsToConfig(false),
        );
        el('targetConfigTextarea')?.addEventListener('input', () =>
          fillPaginationFieldsFromConfig(),
        );
        el('resultsRunSelect')?.addEventListener('change', async (e) => {
          const v = String(e.target.value || '');
          await loadRunPosts(v);
        });
      }

      async function init() {
        attachHandlers();
        try {
          const r = await apiGet('api/presets');
          state.presets = r.data || [];
          state.selectedPresetId = state.presets[0]?.id || '';
          renderPresets();
          const p = state.presets.find((x) => x.id === state.selectedPresetId);
          state.targets = targetsFromPreset(p);
          renderTargets();
        } catch (e) {
          notify(String(e.message || e), 'error');
        }
        await refreshRuns();
        await refreshJobs();
        await refreshProgress();
        await refreshLog();
        window.setInterval(refreshProgress, 1200);
        window.setInterval(refreshLog, 2500);
        window.setInterval(refreshRuns, 4000);
        window.setInterval(refreshJobs, 8000);
      }

      init();

      // Outside click to close modals
      window.onclick = function (event) {
        if (event.target.classList.contains('modal-overlay')) {
          event.target.classList.add('hidden');
        }
      };
    </script>
  </body>
</html>
